# Nano-Bananary 数据库维护手册

## 1. 手册简介

本手册提供了Nano-Bananary项目数据库维护脚本的详细使用指南，帮助管理员执行日常数据库维护任务，包括查看用户信息、删除用户、查看积分账户信息和数据库统计数据等操作。

## 2. 脚本概述

数据库维护脚本`dbMaintain.ts`是一个离线工具，不需要启动服务器即可运行。该脚本通过命令行接口提供多种数据库维护功能，支持管理员查看、管理用户数据，以及获取数据库整体统计信息。

### 2.1 脚本位置

```
/scripts/dbMaintain.ts
```

### 2.2 依赖说明

脚本依赖以下包：
- `sqlite3`：SQLite数据库驱动
- `sqlite`：Promise风格的SQLite接口
- `readline`：Node.js内置模块，用于命令行交互
- `ts-node`：用于直接运行TypeScript文件

## 3. 使用方法

在项目根目录下，通过`npm`命令运行维护脚本：

```bash
npm run db:maintain -- [命令] [参数]
```

> **注意**：命令和参数之间需要使用`--`分隔

## 4. 可用命令详解

### 4.1 查看所有用户信息

**命令**：`list-users`

**功能**：显示数据库中所有用户的详细信息，包括用户ID、用户名、邮箱、电话、验证状态、积分余额和创建时间等。

**使用示例**：

```bash
npm run db:maintain -- list-users
```

**样例输出**：

```
====================================
      Nano-Bananary 数据库维护工具      
====================================
数据库连接成功！

===== 所有用户信息 =====
总用户数: 3

1. 用户ID: 10481aff-ed6f-4e61-ab88-26cc2ceb129c
   用户名: xcode
   邮箱: 11@qq.com
   电话: 未设置
   是否已验证: 是
   积分余额: 100.0
   创建时间: 2024-07-01 10:15:30

2. 用户ID: 23f4567e-8d9c-4a0b-8e7d-6c5b4a3f2e1d
   用户名: alice
   邮箱: alice@example.com
   电话: 13800138000
   是否已验证: 是
   积分余额: 50.0
   创建时间: 2024-07-02 14:20:45

3. 用户ID: 34e5f67d-8c9b-4a0f-8e7d-6c5b4a3f2e1d
   用户名: bob
   邮箱: bob@example.com
   电话: 13900139000
   是否已验证: 是
   积分余额: 0
   创建时间: 2024-07-03 09:30:15

数据库连接已关闭
```

### 4.2 删除用户

**命令**：`delete-user [用户ID/用户名]`

**功能**：根据用户ID或用户名删除指定用户及其所有相关数据（包括积分账户、交易记录、支付记录和服务使用记录）。

**参数**：
- `用户ID/用户名`：要删除的用户的唯一标识（必需）

**使用示例**：

```bash
npm run db:maintain -- delete-user xcode
# 或
npm run db:maintain -- delete-user 10481aff-ed6f-4e61-ab88-26cc2ceb129c
```

**样例输出**：

```
====================================
      Nano-Bananary 数据库维护工具      
====================================
数据库连接成功！

确认删除用户:
用户ID: 10481aff-ed6f-4e61-ab88-26cc2ceb129c
用户名: xcode
邮箱: 11@qq.com
此操作将删除该用户的所有相关数据，包括积分账户和交易记录！
请确认是否继续 (y/n): y
成功删除用户: xcode (11@qq.com)

数据库连接已关闭
```

### 4.3 查看用户积分账户信息

**命令**：`list-accounts`

**功能**：显示所有用户的积分账户信息，包括用户名、邮箱、积分余额和最后更新时间，并按积分余额降序排列。

**使用示例**：

```bash
npm run db:maintain -- list-accounts
```

**样例输出**：

```
====================================
      Nano-Bananary 数据库维护工具      
====================================
数据库连接成功！

===== 用户积分账户信息 =====
总账户数: 3

1. 用户名: xcode
   邮箱: 11@qq.com
   积分余额: 100.0
   最后更新时间: 2024-07-05 16:45:30

2. 用户名: alice
   邮箱: alice@example.com
   积分余额: 50.0
   最后更新时间: 2024-07-04 11:20:15

3. 用户名: bob
   邮箱: bob@example.com
   积分余额: 0
   最后更新时间: 2024-07-03 09:30:15

数据库连接已关闭
```

### 4.4 查看数据库统计信息

**命令**：`stats`

**功能**：显示数据库的整体统计信息，包括用户总数、已验证用户数、积分账户数、系统总积分、交易记录数、服务使用记录数和支付记录数等。

**使用示例**：

```bash
npm run db:maintain -- stats
```

**样例输出**：

```
====================================
      Nano-Bananary 数据库维护工具      
====================================
数据库连接成功！

===== 数据库统计信息 =====
用户总数: 3
已验证用户数: 3
积分账户数: 3
系统总积分: 150.0
积分交易记录数: 10
服务使用记录数: 25
支付记录数: 2

数据库连接已关闭
```

### 4.5 显示帮助信息

**命令**：`help`

**功能**：显示脚本的使用说明和可用命令列表。

**使用示例**：

```bash
npm run db:maintain -- help
# 或直接运行不带参数的命令
npm run db:maintain
```

**样例输出**：

```
====================================
      Nano-Bananary 数据库维护工具      
====================================
数据库连接成功！

===== 数据库维护脚本使用说明 =====
该脚本用于执行数据库维护任务，如查看用户信息、删除用户等操作。

使用方法:
  npm run db:maintain -- [命令] [参数]

可用命令:
  list-users          - 查看所有用户信息
  delete-user [id/用户名] - 根据ID或用户名删除用户
  list-accounts       - 查看所有用户积分账户信息
  stats               - 查看数据库统计信息
  help                - 显示帮助信息

示例:
  npm run db:maintain -- list-users
  npm run db:maintain -- delete-user john_doe
  npm run db:maintain -- stats

数据库连接已关闭
```

## 5. 注意事项和最佳实践

1. **操作前备份**：在执行删除操作前，请确保已备份数据库，以防止意外数据丢失。

2. **谨慎删除**：删除用户操作会同时删除该用户的所有相关数据，包括积分账户、交易记录、支付记录和服务使用记录，请谨慎操作。

3. **权限控制**：请确保只有授权的管理员才能访问和运行此脚本。

4. **错误处理**：脚本包含完整的错误处理机制，如果遇到问题，会显示详细的错误信息。

5. **事务支持**：删除用户操作使用事务确保数据一致性，要么全部成功，要么全部失败并回滚。

6. **确认机制**：删除用户时需要二次确认，避免误操作。

7. **离线运行**：该脚本是离线工具，不需要启动服务器即可运行，适合在维护窗口使用。

## 6. 常见问题解决

### 6.1 `require is not defined` 错误

**问题描述**：执行脚本时出现 `require is not defined` 错误。

**解决方案**：这是因为项目使用ES Module模式，而脚本中使用了CommonJS的`require()`语法。确保脚本中使用动态导入语法：`(await import('readline'))` 替代 `require('readline')`。

### 6.2 数据库连接失败

**问题描述**：无法连接到数据库，显示 `数据库连接失败` 错误。

**解决方案**：
1. 检查`database.sqlite`文件是否存在于项目根目录
2. 检查文件权限是否正确
3. 确保`sqlite3`和`sqlite`包已正确安装（运行`npm install`）

### 6.3 命令执行失败

**问题描述**：命令执行过程中出现错误。

**解决方案**：检查错误消息，根据提示进行修复。常见问题包括：
- 指定的用户不存在（删除用户时）
- 数据库文件损坏
- 磁盘空间不足

## 7. 版本历史

| 版本 | 日期 | 修改内容 |
|------|------|---------|
| 1.0  | 2024-07-10 | 初始版本，包含基本的用户管理和统计功能 |
| 1.1  | 2024-07-15 | 修复了ES Module兼容性问题，添加了事务支持 |